<!DOCTYPE html>
<html>
<head>
    <title>Fix Profanity Counts</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBQqQqQqQqQqQqQqQqQqQqQqQqQqQqQqQ",
            authDomain: "polyglai-5591c.firebaseapp.com",
            projectId: "polyglai-5591c",
            storageBucket: "polyglai-5591c.appspot.com",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        async function fixProfanityCounts() {
            try {
                // Sign in anonymously
                const userCredential = await signInAnonymously(auth);
                console.log('Signed in as:', userCredential.user.uid);

                // Get all users
                const usersSnapshot = await getDocs(collection(db, 'users'));
                console.log(`Found ${usersSnapshot.docs.length} users`);

                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    
                    // Count actual profanity records for this user
                    const profanityQuery = query(
                        collection(db, 'profanity_records'),
                        where('userId', '==', userId)
                    );
                    const profanitySnapshot = await getDocs(profanityQuery);
                    const actualCount = profanitySnapshot.docs.length;
                    
                    const currentCount = userData.profanityCount || 0;
                    
                    console.log(`User ${userId}:`);
                    console.log(`  Current profanityCount: ${currentCount}`);
                    console.log(`  Actual profanity records: ${actualCount}`);
                    
                    if (currentCount !== actualCount) {
                        console.log(`  ⚠️  MISMATCH! Updating to ${actualCount}`);
                        
                        // Update the user's profanity count to match actual records
                        await updateDoc(doc(db, 'users', userId), {
                            profanityCount: actualCount
                        });
                        
                        console.log(`  ✅ Updated profanityCount to ${actualCount}`);
                    } else {
                        console.log(`  ✅ Counts match`);
                    }
                }

                console.log('✅ All profanity counts have been fixed!');
                alert('Profanity counts have been fixed! Check the dashboard now.');
                
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Add button to fix
        document.addEventListener('DOMContentLoaded', () => {
            const button = document.createElement('button');
            button.textContent = 'Fix Profanity Counts';
            button.onclick = fixProfanityCounts;
            button.style.cssText = 'padding: 10px 20px; font-size: 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px;';
            document.body.appendChild(button);
            
            const info = document.createElement('div');
            info.innerHTML = `
                <h2>Fix Profanity Counts</h2>
                <p>This tool will:</p>
                <ul>
                    <li>Count actual profanity records for each user</li>
                    <li>Update the profanityCount field to match the actual count</li>
                    <li>Fix the mismatch between total violations and recent records</li>
                </ul>
                <p><strong>Warning:</strong> This will modify your Firestore data!</p>
            `;
            info.style.cssText = 'margin: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px;';
            document.body.appendChild(info);
        });
    </script>
</head>
<body>
    <h1>Fix Profanity Counts</h1>
    <p>Click the button to fix the profanity count mismatches.</p>
</body>
</html>
